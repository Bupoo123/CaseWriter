<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaseWriter - 病例报告撰写助手</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
    <div id="app">
        <!-- 顶部导航栏 -->
        <header class="header">
            <div class="container">
                <h1 class="logo">CaseWriter</h1>
                <nav class="nav">
                    <button @click="currentView = 'evaluation'" :class="{ active: currentView === 'evaluation' }">价值评估</button>
                    <button @click="currentView = 'writing'" :class="{ active: currentView === 'writing' }">撰写流程</button>
                    <button @click="currentView = 'guide'" :class="{ active: currentView === 'guide' }">写作指导</button>
                    <button @click="currentView = 'templates'" :class="{ active: currentView === 'templates' }">模板库</button>
                    <button @click="currentView = 'journals'" :class="{ active: currentView === 'journals' }">期刊选择</button>
                </nav>
            </div>
        </header>

        <!-- 主内容区 -->
        <main class="main">
            <div class="container">
                <!-- 撰写流程视图 -->
                <div v-if="currentView === 'writing'" class="writing-view">
                    <div class="sidebar">
                        <h2>CARE 2013 撰写流程</h2>
                        <ul class="section-nav">
                            <li v-for="(section, index) in careSections" :key="index"
                                @click="activeSection = index"
                                :class="{ active: activeSection === index }">
                                {{ section.title }} <span v-if="section.enTitle">({{ section.enTitle }})</span>
                            </li>
                        </ul>
                        <div class="sidebar-actions">
                            <button @click="newCase" class="btn btn-secondary">新建病例</button>
                            <button @click="saveToLocal" class="btn btn-primary">保存到本地</button>
                            <button @click="exportToWord" class="btn btn-success">导出 Word</button>
                            <button @click="exportToMarkdown" class="btn btn-success">导出 Markdown</button>
                            <button @click="loadFromLocal" class="btn btn-secondary">从本地加载</button>
                        </div>
                    </div>
                    <div class="content-area">
                        <div v-if="activeSection !== null" class="section-editor">
                            <h2>{{ careSections[activeSection].title }} <span v-if="careSections[activeSection].enTitle">({{ careSections[activeSection].enTitle }})</span></h2>
                            <p class="section-description">{{ careSections[activeSection].description }}</p>
                            <div class="editor-wrapper">
                                <textarea 
                                    v-model="careSections[activeSection].content"
                                    class="editor"
                                    :placeholder="careSections[activeSection].placeholder"
                                    @input="autoSave"
                                ></textarea>
                            </div>
                            <!-- 时间线事件编辑器（仅在第7章显示） -->
                            <div v-if="careSections[activeSection].title.startsWith('7.')" class="timeline-tool">
                                <h3>时间线事件编辑器</h3>
                                <div class="timeline-form">
                                    <input type="date" v-model="timelineForm.date" class="filter-input" />
                                    <input type="text" v-model="timelineForm.event" placeholder="事件/检查/治疗" class="filter-input" />
                                    <input type="text" v-model="timelineForm.note" placeholder="备注（可选）" class="filter-input" />
                                    <button class="btn btn-primary" @click="addTimelineEvent">添加</button>
                                </div>
                                <div class="journals-table" v-if="timelineEvents.length">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>日期</th>
                                                <th>事件</th>
                                                <th>备注</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="(ev, i) in timelineEvents" :key="i">
                                                <td>{{ ev.date }}</td>
                                                <td>{{ ev.event }}</td>
                                                <td>{{ ev.note }}</td>
                                                <td><button class="btn btn-sm" @click="removeTimelineEvent(i)">删除</button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <button v-if="timelineEvents.length" class="btn btn-success" @click="syncTimelineToContent">同步为表格到编辑器</button>
                            </div>
                            <div class="writing-tips" v-if="careSections[activeSection].tips">
                                <h3>写作提示</h3>
                                <ul>
                                    <li v-for="(tip, tipIndex) in careSections[activeSection].tips" :key="tipIndex">{{ tip }}</li>
                                </ul>
                            </div>
                        </div>
                        <div v-else class="welcome-screen">
                            <h2>欢迎使用 CaseWriter</h2>
                            <p>请从左侧选择要撰写的章节开始</p>
                        </div>
                    </div>
                </div>

                <!-- 写作指导视图 -->
                <div v-if="currentView === 'guide'" class="guide-view">
                    <h2>写作指导与知识库</h2>
                    <div class="guide-content">
                        <div class="guide-section" v-for="(guide, index) in writingGuides" :key="index">
                            <h3>{{ guide.title }}</h3>
                            <div class="guide-body">
                                <div v-if="guide.type === 'tips'">
                                    <ul>
                                        <li v-for="(tip, tipIndex) in guide.content" :key="tipIndex">{{ tip }}</li>
                                    </ul>
                                </div>
                                <div v-else-if="guide.type === 'example'">
                                    <pre><code>{{ guide.content }}</code></pre>
                                </div>
                                <div v-else>
                                    <p v-for="(para, paraIndex) in guide.content" :key="paraIndex">{{ para }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 价值评估视图 -->
                <div v-if="currentView === 'evaluation'" class="evaluation-view">
                    <h2>Case Report 发表价值评估</h2>
                    <p class="intro-text">本模块帮助您评估病例报告的发表价值，判断该案例是否值得发表。</p>
                    <div class="title-pattern">
                        <strong>什么样的案例可以投 Case？</strong><br>
                        病例具有“独特性”：与既往病例或常规诊疗不同，如新的解决方案、新的病原体、新的合并症等。
                    </div>

                    <!-- 发表的典型特征 -->
                    <div class="evaluation-section">
                        <h3>一、发表的典型特征（哪些值得发表）</h3>
                        <div class="feature-list">
                            <div class="feature-item" v-for="(feature, index) in publicationFeatures" :key="index">
                                <div class="feature-number">{{ index + 1 }}️⃣</div>
                                <div class="feature-content">
                                    <h4>{{ feature.title }}</h4>
                                    <p class="feature-examples">{{ feature.examples }}</p>
                                    <p class="feature-reason"><strong>发表理由：</strong>{{ feature.reason }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 评估维度表格 -->
                    <div class="evaluation-section">
                        <h3>二、评估维度与发表价值</h3>
                        <div class="evaluation-table-wrapper">
                            <table class="evaluation-table">
                                <thead>
                                    <tr>
                                        <th>评估维度</th>
                                        <th>描述</th>
                                        <th>发表价值</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(dimension, index) in evaluationDimensions" :key="index">
                                        <td><strong>{{ dimension.dimension }}</strong></td>
                                        <td>{{ dimension.description }}</td>
                                        <td>
                                            <span class="value-stars">{{ dimension.value }}</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 投稿期刊分布 -->
                    <div class="evaluation-section">
                        <h3>三、投稿期刊分布特点</h3>
                        <ul class="journal-distribution">
                            <li><strong>Frontiers 系列</strong>（Public Health, Cell Infect Microbiol, Medicine）占比高</li>
                            <li><strong>BMC 系列</strong>、Heliyon、Infect Drug Resist 为主流开放获取渠道</li>
                            <li>大多属 <strong>OA 期刊</strong>，APC 1000–3000 美元范围</li>
                            <li>说明此类 mNGS 病例目前投稿难度适中，重在病例质量与新颖性</li>
                        </ul>
                    </div>
                </div>

                <!-- 模板库视图 -->
                <div v-if="currentView === 'templates'" class="templates-view">
                    <h2>模板与案例库</h2>
                    <p class="intro-text">下载CARE清单、指南文件、已发表案例和经典高分案例</p>
                    
                    <div class="filter-bar">
                        <input type="text" v-model="templateFilter" placeholder="搜索模板或案例..." class="filter-input">
                        <select v-model="templateCategoryFilter" class="filter-select">
                            <option value="">所有分类</option>
                            <option value="清单">清单</option>
                            <option value="指南">指南</option>
                            <option value="已发表案例">已发表案例</option>
                            <option value="经典高分案例">经典高分案例</option>
                        </select>
                    </div>

                    <div v-if="loadingTemplates" class="loading">加载中...</div>
                    <div v-else-if="filteredTemplates.length === 0" class="no-results">未找到匹配的模板或案例</div>
                    <div v-else class="templates-grid">
                        <div v-for="item in filteredTemplates" :key="item.id" class="template-card">
                            <div class="template-header">
                                <h3>{{ item.name }}</h3>
                                <span class="template-category">{{ item.category }}</span>
                            </div>
                            <p class="template-description">{{ item.description }}</p>
                            <div class="template-meta">
                                <span v-if="item.journal" class="meta-item">期刊: {{ item.journal }}</span>
                                <span v-if="item.year" class="meta-item">年份: {{ item.year }}</span>
                                <span class="meta-item">格式: {{ item.format }}</span>
                                <span class="meta-item">大小: {{ item.size }}</span>
                            </div>
                            <div v-if="item.tags && item.tags.length" class="template-tags">
                                <span v-for="tag in item.tags" :key="tag" class="tag">{{ tag }}</span>
                            </div>
                            <div class="template-actions">
                                <button v-if="item.files && item.files.length > 1" @click="showMultiFileDialog(item)" class="btn btn-primary">下载 ({{ item.files.length }}个文件)</button>
                                <a v-else :href="getDownloadUrl(item)" target="_blank" class="btn btn-primary">下载</a>
                                <a v-if="item.format === 'pdf'" :href="getDownloadUrl(item)" target="_blank" class="btn btn-secondary">在线查看</a>
                            </div>
                        </div>
                    </div>

                    <!-- 多文件下载对话框 -->
                    <div v-if="selectedMultiFileItem" class="modal-overlay" @click="selectedMultiFileItem = null">
                        <div class="modal-content" @click.stop>
                            <h3>{{ selectedMultiFileItem.name }}</h3>
                            <p>该案例包含多个文件，请选择要下载的文件：</p>
                            <ul class="file-list">
                                <li v-for="(file, index) in selectedMultiFileItem.files" :key="index">
                                    <a :href="getFileDownloadUrl(file)" target="_blank" class="file-link">{{ getFileName(file) }}</a>
                                </li>
                            </ul>
                            <button @click="selectedMultiFileItem = null" class="btn btn-secondary">关闭</button>
                        </div>
                    </div>
                </div>

                <!-- 期刊选择视图 -->
                <div v-if="currentView === 'journals'" class="journals-view">
                    <h2>期刊选择与模板下载</h2>
                    <div class="filter-bar">
                        <input type="text" v-model="journalFilter" placeholder="搜索期刊..." class="filter-input">
                        <select v-model="journalTopicFilter" class="filter-select">
                            <option value="">所有主题</option>
                            <option v-for="topic in journalTopics" :key="topic" :value="topic">{{ topic }}</option>
                        </select>
                        <select v-model="journalOAFilter" class="filter-select">
                            <option value="">所有类型</option>
                            <option value="是">开放获取</option>
                            <option value="否">非开放获取</option>
                        </select>
                        <select v-model="journalAcceptsFilter" class="filter-select">
                            <option value="">接收病例报告（全部）</option>
                            <option value="接收">仅接收</option>
                            <option value="不接收">不接收</option>
                        </select>
                        <label style="display:flex;align-items:center;gap:0.3rem;">
                            <input type="checkbox" v-model="journalVerifiedOnly"> 仅显示已验证链接
                        </label>
                        <label style="display:flex;align-items:center;gap:0.3rem;">
                            <input type="checkbox" v-model="showAdvancedJournalFields"> 显示高级字段
                        </label>
                    </div>
                    <div class="journals-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>期刊名称</th>
                                    <th>主题方向</th>
                                    <th>出版社</th>
                                    <th>是否OA</th>
                                    <th>APC</th>
                                    <th v-if="showAdvancedJournalFields">2025 IF</th>
                                    <th v-if="showAdvancedJournalFields">5-Year IF</th>
                                    <th v-if="showAdvancedJournalFields">JCR分区</th>
                                    <th v-if="showAdvancedJournalFields">中科院分区</th>
                                    <th v-if="showAdvancedJournalFields">ISSN/eISSN</th>
                                    <th v-if="showAdvancedJournalFields">接受Case</th>
                                    <th v-if="showAdvancedJournalFields">预警状态</th>
                                    <th v-if="showAdvancedJournalFields">验证</th>
                                    <th>投稿网址</th>
                                    <th>模板链接</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(journal, index) in filteredJournals" :key="index">
                                    <td>{{ journal.name || '-' }}</td>
                                    <td>{{ journal.topic }}</td>
                                    <td>{{ journal.publisher }}</td>
                                    <td>{{ journal.oa }}</td>
                                    <td>{{ journal.apc }}</td>
                                    <td v-if="showAdvancedJournalFields">{{ journal.if2025 || '-' }}</td>
                                    <td v-if="showAdvancedJournalFields">{{ journal.if5year || '-' }}</td>
                                    <td v-if="showAdvancedJournalFields">{{ journal.jifQuartile || '-' }}</td>
                                    <td v-if="showAdvancedJournalFields">{{ journal.casDivision || '-' }}</td>
                                    <td v-if="showAdvancedJournalFields">{{ (journal.issn || '-') + (journal.eissn ? (' / ' + journal.eissn) : '') }}</td>
                                    <td v-if="showAdvancedJournalFields">{{ journal.acceptsCaseReport ? '是' : '否' }}</td>
                                    <td v-if="showAdvancedJournalFields">{{ journal.warningStatus || '正常' }}</td>
                                    <td v-if="showAdvancedJournalFields">{{ journal.verified ? '已验证' : '未验证' }}</td>
                                    <td><a :href="journal.submissionUrl" target="_blank">投稿链接</a></td>
                                    <td><a :href="journal.templateUrl" target="_blank">模板链接</a></td>
                                    <td>
                                        <button @click="openJournal(journal.submissionUrl)" class="btn btn-sm">投稿</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- 底部信息 -->
        <footer class="footer">
            <div class="container">
                <p>CaseWriter V1.2 - 基于 CARE 2013 标准的病例报告撰写助手</p>
            </div>
        </footer>
    </div>

    <script src="js/app.js"></script>
</body>
</html>

